name: Multi-Asset Backtest

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'confluence-engine/src/backtesting/**'
      - '.github/workflows/backtest.yml'

  workflow_dispatch:
    inputs:
      stocks:
        description: "All instruments — stocks, ETFs, treasuries, commodities (space-separated). Leave empty to use full watchlist.yaml (80 tickers)."
        required: false
        default: ""
        type: string
      crypto:
        description: "Crypto pairs (space-separated)"
        required: false
        default: "BTC/USDT ETH/USDT SOL/USDT BNB/USDT XRP/USDT ADA/USDT AVAX/USDT DOGE/USDT LINK/USDT DOT/USDT MATIC/USDT"
        type: string
      futures:
        description: "Futures symbols — uses ETF proxies in CI (space-separated)"
        required: false
        default: "ES NQ GC CL ZB ZN"
        type: string
      period:
        description: "Stock data period"
        required: false
        default: "10y"
        type: choice
        options:
          - "1y"
          - "2y"
          - "5y"
          - "10y"
      crypto_days:
        description: "Days of crypto history"
        required: false
        default: "1825"
        type: choice
        options:
          - "365"
          - "730"
          - "1825"
          - "3650"
      mode:
        description: "Analysis mode"
        required: false
        default: "walk-forward"
        type: choice
        options:
          - "basic"
          - "walk-forward"
          - "cpcv"
          - "optimize"
      capital:
        description: "Starting capital ($)"
        required: false
        default: "100000"
        type: string

env:
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  # ──────────────────────────────────────────────
  # STOCK BACKTEST
  # ──────────────────────────────────────────────
  stocks:
    name: "Stocks Backtest"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: confluence-engine

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: confluence-engine/requirements-backtest.txt

      - name: Install dependencies
        run: pip install -r requirements-backtest.txt

      - name: Run stock backtest
        run: |
          STOCKS="${{ inputs.stocks }}"
          PERIOD="${{ inputs.period || '10y' }}"
          MODE="${{ inputs.mode || 'walk-forward' }}"
          CAPITAL="${{ inputs.capital || '100000' }}"

          if [ -z "$STOCKS" ]; then
            ARGS="--watchlist --period $PERIOD --capital $CAPITAL --output results-stocks.json"
          else
            ARGS="--stocks $STOCKS --period $PERIOD --capital $CAPITAL --output results-stocks.json"
          fi

          if [ "$MODE" = "walk-forward" ]; then
            ARGS="$ARGS --walk-forward --windows 5"
          elif [ "$MODE" = "cpcv" ]; then
            ARGS="$ARGS --cpcv"
          elif [ "$MODE" = "optimize" ]; then
            ARGS="$ARGS --optimize"
          fi

          echo "Running: python -m src.backtesting.runner $ARGS"
          python -m src.backtesting.runner $ARGS 2>&1 | tee stock-output.log

      - name: Post stock results to summary
        if: always()
        run: |
          echo "## Stock Backtest Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -80 stock-output.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          if [ -f results-stocks.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Top Strategies" >> $GITHUB_STEP_SUMMARY
            echo "| Strategy | Symbol | Sharpe | CAGR | Max DD | Win Rate | Trades |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|--------|------|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
            python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
          import json
          data = json.load(open('results-stocks.json'))
          results = data.get('results', [])
          # Only show strategies with 30+ trades (statistically meaningful)
          viable = [r for r in results if int(str(r.get('total_trades', '0'))) >= 30]
          viable.sort(key=lambda x: float(str(x.get('sharpe', '0')).replace('+', '')), reverse=True)
          if viable:
              for r in viable[:15]:
                  print(f"| {r.get('strategy','?')} | {r.get('symbol','?')} | {r.get('sharpe','?')} | {r.get('cagr','?')} | {r.get('max_drawdown','?')} | {r.get('win_rate','?')} | {r.get('total_trades','?')} |")
          else:
              # Fallback: show all if none have 30+ trades, but flag it
              all_sorted = sorted(results, key=lambda x: float(str(x.get('sharpe', '0')).replace('+', '')), reverse=True)
              print(f"| **NOTE** | | | **No strategies reached 30+ trades** | | | |")
              for r in all_sorted[:10]:
                  print(f"| {r.get('strategy','?')} | {r.get('symbol','?')} | {r.get('sharpe','?')} | {r.get('cagr','?')} | {r.get('max_drawdown','?')} | {r.get('win_rate','?')} | {r.get('total_trades','?')} |")
          PYEOF
          fi

      - name: Upload stock results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stock-results
          path: |
            confluence-engine/results-stocks.json
            confluence-engine/stock-output.log
          retention-days: 30

  # ──────────────────────────────────────────────
  # CRYPTO BACKTEST
  # ──────────────────────────────────────────────
  crypto:
    name: "Crypto Backtest"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: confluence-engine

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: confluence-engine/requirements-backtest.txt

      - name: Install dependencies
        run: pip install -r requirements-backtest.txt

      - name: Run crypto backtest
        run: |
          CRYPTO="${{ inputs.crypto || 'BTC/USDT ETH/USDT SOL/USDT BNB/USDT XRP/USDT ADA/USDT AVAX/USDT DOGE/USDT LINK/USDT DOT/USDT MATIC/USDT' }}"
          DAYS="${{ inputs.crypto_days || '1825' }}"
          MODE="${{ inputs.mode || 'walk-forward' }}"
          CAPITAL="${{ inputs.capital || '100000' }}"

          ARGS="--crypto $CRYPTO --crypto-days $DAYS --capital $CAPITAL --output results-crypto.json"

          if [ "$MODE" = "walk-forward" ]; then
            ARGS="$ARGS --walk-forward"
          elif [ "$MODE" = "cpcv" ]; then
            ARGS="$ARGS --cpcv"
          elif [ "$MODE" = "optimize" ]; then
            ARGS="$ARGS --optimize"
          fi

          echo "Running: python -m src.backtesting.runner $ARGS"
          python -m src.backtesting.runner $ARGS 2>&1 | tee crypto-output.log

      - name: Post crypto results to summary
        if: always()
        run: |
          echo "## Crypto Backtest Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -80 crypto-output.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          if [ -f results-crypto.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Top Strategies" >> $GITHUB_STEP_SUMMARY
            echo "| Strategy | Symbol | Sharpe | CAGR | Max DD | Win Rate | Trades |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|--------|------|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
            python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
          import json
          data = json.load(open('results-crypto.json'))
          results = data.get('results', [])
          viable = [r for r in results if int(str(r.get('total_trades', '0'))) >= 30]
          viable.sort(key=lambda x: float(str(x.get('sharpe', '0')).replace('+', '')), reverse=True)
          if viable:
              for r in viable[:15]:
                  print(f"| {r.get('strategy','?')} | {r.get('symbol','?')} | {r.get('sharpe','?')} | {r.get('cagr','?')} | {r.get('max_drawdown','?')} | {r.get('win_rate','?')} | {r.get('total_trades','?')} |")
          else:
              all_sorted = sorted(results, key=lambda x: float(str(x.get('sharpe', '0')).replace('+', '')), reverse=True)
              print(f"| **NOTE** | | | **No strategies reached 30+ trades** | | | |")
              for r in all_sorted[:10]:
                  print(f"| {r.get('strategy','?')} | {r.get('symbol','?')} | {r.get('sharpe','?')} | {r.get('cagr','?')} | {r.get('max_drawdown','?')} | {r.get('win_rate','?')} | {r.get('total_trades','?')} |")
          PYEOF
          fi

      - name: Upload crypto results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crypto-results
          path: |
            confluence-engine/results-crypto.json
            confluence-engine/crypto-output.log
          retention-days: 30

  # ──────────────────────────────────────────────
  # COMBINED REPORT
  # ──────────────────────────────────────────────
  report:
    name: "Combined Report"
    runs-on: ubuntu-latest
    needs: [stocks, crypto]
    if: always()
    defaults:
      run:
        working-directory: confluence-engine

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: confluence-engine/artifacts

      - name: Generate combined report
        run: |
          python3 << 'PYEOF'
          import json
          import os
          from datetime import datetime, timezone

          all_results = []

          # Merge stock and crypto results
          for artifact_dir in ["artifacts/stock-results", "artifacts/crypto-results"]:
              for fname in os.listdir(artifact_dir) if os.path.isdir(artifact_dir) else []:
                  if fname.endswith(".json"):
                      with open(os.path.join(artifact_dir, fname)) as f:
                          data = json.load(f)
                          all_results.extend(data.get("results", []))

          # Sort by Sharpe
          def get_sharpe(r):
              try:
                  return float(str(r.get("sharpe", "0")).replace("+", ""))
              except (ValueError, TypeError):
                  return 0.0

          all_results.sort(key=get_sharpe, reverse=True)

          # Build summary
          report = {
              "timestamp": datetime.now(timezone.utc).isoformat(),
              "total_strategies_tested": len(all_results),
              "viable_strategies": len([r for r in all_results if get_sharpe(r) > 0.5]),
              "top_5": all_results[:5],
              "all_results": all_results,
          }

          with open("combined-report.json", "w") as f:
              json.dump(report, f, indent=2, default=str)

          # Print summary
          print(f"\n{'=' * 60}")
          print(f"  COMBINED BACKTEST REPORT")
          print(f"  {report['total_strategies_tested']} strategies tested")
          print(f"  {report['viable_strategies']} viable (Sharpe > 0.5)")
          print(f"{'=' * 60}\n")

          if all_results:
              print(f"  {'Strategy':<25} {'Symbol':<12} {'Sharpe':>8} {'CAGR':>8} {'MaxDD':>8}")
              print(f"  {'─' * 65}")
              for r in all_results[:10]:
                  print(f"  {r.get('strategy','?'):<25} {r.get('symbol','?'):<12} {str(r.get('sharpe','?')):>8} {str(r.get('cagr','?')):>8} {str(r.get('max_drawdown','?')):>8}")
          PYEOF

      - name: Post combined summary
        if: always()
        run: |
          echo "## Combined Multi-Asset Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f combined-report.json ]; then
            TOTAL=$(python3 -c "import json; print(json.load(open('combined-report.json'))['total_strategies_tested'])")
            VIABLE=$(python3 -c "import json; print(json.load(open('combined-report.json'))['viable_strategies'])")
            echo "**$TOTAL strategies tested** | **$VIABLE viable** (Sharpe > 0.5)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### Top 5 Strategies" >> $GITHUB_STEP_SUMMARY
            echo "| Rank | Strategy | Symbol | Asset | Sharpe | CAGR | Max DD | P(Overfit) | Deflated SR |" >> $GITHUB_STEP_SUMMARY
            echo "|------|----------|--------|-------|--------|------|--------|------------|-------------|" >> $GITHUB_STEP_SUMMARY
            python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
          import json
          data = json.load(open('combined-report.json'))
          for i, r in enumerate(data.get('top_5', []), 1):
              overfit = r.get('prob_overfit', 'N/A')
              dsr = r.get('deflated_sharpe', r.get('deflated_sharpe', 'N/A'))
              print(f"| {i} | {r.get('strategy','?')} | {r.get('symbol','?')} | {r.get('asset_class','?')} | {r.get('sharpe','?')} | {r.get('cagr','?')} | {r.get('max_drawdown','?')} | {overfit} | {dsr} |")
          PYEOF
          else
            echo "No results files found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload combined report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: combined-report
          path: confluence-engine/combined-report.json
          retention-days: 90
