name: SPY Backtest

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: true
        default: "backtest"
        type: choice
        options:
          - backtest
          - optimize
          - signals
      years:
        description: "Years of historical data"
        required: false
        default: "5"
        type: choice
        options:
          - "1"
          - "3"
          - "5"

jobs:
  backtest:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: confluence-engine

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install yfinance matplotlib tabulate

      - name: Run backtest
        run: |
          chmod +x go.sh
          ./go.sh ${{ inputs.mode }} ${{ inputs.years }}

      - name: Print results summary
        if: inputs.mode != 'signals'
        run: ./go.sh results

      - name: Upload results
        if: inputs.mode != 'signals'
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: |
            confluence-engine/backtest/results/results.json
            confluence-engine/backtest/results/*.png

      - name: Post results to job summary
        if: inputs.mode != 'signals'
        run: |
          echo "## SPY Backtest Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ inputs.mode }} | **Years:** ${{ inputs.years }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f backtest/results/results.json ]; then
            # Extract recommendation
            REC_STRAT=$(python3 -c "import json; d=json.load(open('backtest/results/results.json')); print(d['recommendation']['strategy'])")
            REC_SHARPE=$(python3 -c "import json; d=json.load(open('backtest/results/results.json')); print(d['recommendation']['sharpe'])")
            REC_CAGR=$(python3 -c "import json; d=json.load(open('backtest/results/results.json')); print(d['recommendation']['cagr_pct'])")
            REC_WIN=$(python3 -c "import json; d=json.load(open('backtest/results/results.json')); print(d['recommendation']['win_rate_pct'])")
            REC_ALPHA=$(python3 -c "import json; d=json.load(open('backtest/results/results.json')); print(d['recommendation']['alpha_vs_bh_cagr'])")

            echo "### Recommended Strategy: $REC_STRAT" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Sharpe | $REC_SHARPE |" >> $GITHUB_STEP_SUMMARY
            echo "| CAGR | ${REC_CAGR}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Win Rate | ${REC_WIN}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Alpha vs B&H | ${REC_ALPHA}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Full ranking table
            echo "### Full Ranking" >> $GITHUB_STEP_SUMMARY
            echo "| # | Strategy | Sharpe | CAGR% | Win% | MaxDD% | PF |" >> $GITHUB_STEP_SUMMARY
            echo "|---|----------|--------|-------|------|--------|-----|" >> $GITHUB_STEP_SUMMARY
            python3 -c "
import json
d = json.load(open('backtest/results/results.json'))
for i, r in enumerate(d['ranking'], 1):
    print(f\"| {i} | {r['strategy']} | {r['sharpe']:.2f} | {r['cagr_pct']:.1f} | {r['win_rate_pct']:.1f} | {r['max_drawdown_pct']:.1f} | {r['profit_factor']:.2f} |\")
" >> $GITHUB_STEP_SUMMARY
          fi
