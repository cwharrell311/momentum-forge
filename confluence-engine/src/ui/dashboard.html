<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confluence Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: #e2e8f0; font-family: 'Inter', system-ui, sans-serif; }
        .regime-calm { background: #065f46; color: #6ee7b7; }
        .regime-elevated { background: #78350f; color: #fcd34d; }
        .regime-stressed { background: #7c2d12; color: #fb923c; }
        .regime-crisis { background: #7f1d1d; color: #fca5a5; }
        .regime-unknown { background: #334155; color: #94a3b8; }
        .bullish { color: #4ade80; }
        .bearish { color: #f87171; }
        .neutral { color: #94a3b8; }
        .conviction-bar { height: 8px; border-radius: 4px; transition: width 0.5s ease; }
        .ticker-row { transition: background 0.15s ease; cursor: pointer; }
        .ticker-row:hover { background: #1e293b; }
        .signal-chip { padding: 2px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 500; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .detail-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; }
        .detail-panel.open { max-height: 600px; padding: 16px 0; }
        .cache-fresh { color: #4ade80; }
        .cache-stale { color: #fcd34d; }
        .cache-old { color: #f87171; }
        .change-up { color: #4ade80; }
        .change-down { color: #f87171; }
        .change-flat { color: #94a3b8; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="border-b border-slate-700 px-6 py-4">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Confluence Engine</h1>
                <p class="text-sm text-slate-400 mt-1">Multi-layer signal confluence for options & equity trading</p>
            </div>
            <div class="flex items-center gap-4">
                <div id="regime-badge" class="regime-unknown px-4 py-2 rounded-lg font-semibold text-sm">
                    Loading regime...
                </div>
                <div class="text-right text-xs">
                    <div class="text-slate-500">Cache age</div>
                    <div id="cache-age" class="text-slate-400 font-mono">—</div>
                </div>
                <div class="text-right text-xs">
                    <div class="text-slate-500">Next scan</div>
                    <div id="next-scan" class="text-slate-400 font-mono">—</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-6 py-6">

        <!-- Stats Bar -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-xs text-slate-400 uppercase tracking-wide">Tickers Scanned</div>
                <div id="stat-scanned" class="text-2xl font-bold text-white mt-1">—</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-xs text-slate-400 uppercase tracking-wide">Signals Firing</div>
                <div id="stat-firing" class="text-2xl font-bold text-white mt-1">—</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-xs text-slate-400 uppercase tracking-wide">Top Conviction</div>
                <div id="stat-top" class="text-2xl font-bold mt-1">—</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-xs text-slate-400 uppercase tracking-wide">Active Layers</div>
                <div id="stat-layers" class="text-2xl font-bold text-white mt-1">2 / 8</div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-20">
            <div class="inline-block w-8 h-8 border-4 border-slate-600 border-t-blue-500 rounded-full animate-spin"></div>
            <p class="text-slate-400 mt-4">Scanning watchlist...</p>
            <p class="text-slate-500 text-sm mt-1">First scan takes 30-60 seconds (fetching data for all tickers)</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-20 hidden">
            <p class="text-slate-400 text-lg">No signals firing right now</p>
            <p class="text-slate-500 text-sm mt-2">The scanner checks every 15 minutes. If markets are closed, data may be stale.</p>
        </div>

        <!-- Confluence Table -->
        <div id="confluence-table" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Confluence Screener</h2>
                <div class="flex items-center gap-3">
                    <span id="market-status" class="text-xs text-slate-500"></span>
                    <button onclick="refreshData()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-md text-slate-300 transition">
                        Refresh Now
                    </button>
                </div>
            </div>

            <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                <!-- Table Header -->
                <div class="grid grid-cols-12 gap-2 px-4 py-3 text-xs font-medium text-slate-400 uppercase tracking-wide border-b border-slate-700">
                    <div class="col-span-1">#</div>
                    <div class="col-span-3">Ticker</div>
                    <div class="col-span-1">Dir</div>
                    <div class="col-span-3">Conviction</div>
                    <div class="col-span-2">Layers</div>
                    <div class="col-span-2">Signals</div>
                </div>

                <!-- Table Body -->
                <div id="table-body"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-800 mt-12 py-4 text-center text-xs text-slate-600">
        Confluence Engine v0.1.0 &middot; Phase 1: Momentum + VIX Regime &middot; Scans every 15 min &middot; Dashboard refreshes every 30s
    </footer>

    <script>
        const API = '';  // Same origin
        let lastCacheAge = null;

        // ── Helpers ──
        function formatCacheAge(seconds) {
            if (seconds == null || seconds === 0) return 'just now';
            if (seconds < 60) return `${Math.round(seconds)}s ago`;
            if (seconds < 3600) return `${Math.round(seconds / 60)}m ago`;
            return `${Math.round(seconds / 3600)}h ago`;
        }

        function cacheAgeClass(seconds) {
            if (seconds == null) return 'text-slate-400';
            if (seconds < 300) return 'cache-fresh';     // < 5 min
            if (seconds < 900) return 'cache-stale';     // < 15 min
            return 'cache-old';                           // > 15 min
        }

        function formatPrice(price) {
            if (price == null) return '';
            return `$${Number(price).toFixed(2)}`;
        }

        function formatChange(pct) {
            if (pct == null) return '';
            const num = Number(pct);
            const sign = num >= 0 ? '+' : '';
            return `${sign}${num.toFixed(2)}%`;
        }

        function changeClass(pct) {
            if (pct == null) return 'change-flat';
            return Number(pct) >= 0 ? 'change-up' : 'change-down';
        }

        // Extract price info from momentum signal metadata
        function getPriceInfo(score) {
            const momentum = (score.signals || []).find(s => s.layer === 'momentum');
            if (momentum && momentum.metadata) {
                return {
                    price: momentum.metadata.price,
                    change_pct: momentum.metadata.change_pct,
                    sma_50: momentum.metadata.sma_50,
                    sma_200: momentum.metadata.sma_200,
                };
            }
            return { price: null, change_pct: null, sma_50: null, sma_200: null };
        }

        // ── Fetch Regime ──
        async function fetchRegime() {
            try {
                const resp = await fetch(`${API}/api/v1/regime`);
                const data = await resp.json();
                const badge = document.getElementById('regime-badge');
                const regime = data.regime || 'unknown';

                badge.className = `regime-${regime} px-4 py-2 rounded-lg font-semibold text-sm`;

                let label = regime.toUpperCase();
                if (data.vix_level) {
                    label += ` (VIX ${data.vix_level.toFixed(1)})`;
                }
                badge.textContent = label;
            } catch (e) {
                console.error('Regime fetch failed:', e);
            }
        }

        // ── Fetch Confluence Scores ──
        async function fetchConfluence() {
            try {
                const resp = await fetch(`${API}/api/v1/confluence`);
                const data = await resp.json();

                // Update stats
                document.getElementById('stat-scanned').textContent = data.scanned_tickers || 0;
                document.getElementById('stat-firing').textContent = data.scores?.length || 0;

                if (data.scores && data.scores.length > 0) {
                    const top = data.scores[0];
                    const topEl = document.getElementById('stat-top');
                    topEl.textContent = `${top.conviction}%`;
                    topEl.className = `text-2xl font-bold mt-1 ${top.direction === 'bullish' ? 'bullish' : top.direction === 'bearish' ? 'bearish' : 'neutral'}`;
                }

                // Update cache age
                lastCacheAge = data.cache_age_seconds;
                updateCacheDisplay(data.cache_age_seconds);

                // Render table
                renderTable(data.scores || []);

                // Show/hide states
                document.getElementById('loading').classList.add('hidden');
                if (data.scores && data.scores.length > 0) {
                    document.getElementById('confluence-table').classList.remove('hidden');
                    document.getElementById('empty-state').classList.add('hidden');
                } else {
                    document.getElementById('confluence-table').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Confluence fetch failed:', e);
                document.getElementById('loading').innerHTML = `
                    <p class="text-red-400 text-lg">Connection error</p>
                    <p class="text-slate-500 text-sm mt-2">Make sure the server is running on port 8000</p>
                `;
            }
        }

        function updateCacheDisplay(seconds) {
            const ageEl = document.getElementById('cache-age');
            ageEl.textContent = formatCacheAge(seconds);
            ageEl.className = `font-mono ${cacheAgeClass(seconds)}`;

            // Estimate next scan (15 min default)
            const nextEl = document.getElementById('next-scan');
            if (seconds != null) {
                const remaining = Math.max(0, 900 - seconds);
                nextEl.textContent = formatCacheAge(-remaining).replace(' ago', '');
                if (remaining <= 0) {
                    nextEl.textContent = 'any moment';
                    nextEl.className = 'font-mono cache-fresh pulse';
                } else {
                    nextEl.textContent = `~${Math.ceil(remaining / 60)}m`;
                    nextEl.className = 'font-mono text-slate-400';
                }
            }
        }

        // ── Render Confluence Table ──
        function renderTable(scores) {
            const body = document.getElementById('table-body');
            body.innerHTML = '';

            scores.forEach((score, index) => {
                const dirColor = score.direction === 'bullish' ? 'bullish' : score.direction === 'bearish' ? 'bearish' : 'neutral';
                const dirArrow = score.direction === 'bullish' ? '&#9650;' : score.direction === 'bearish' ? '&#9660;' : '&#9644;';
                const barColor = score.direction === 'bullish' ? 'bg-green-500' : score.direction === 'bearish' ? 'bg-red-500' : 'bg-slate-500';
                const barBg = 'bg-slate-700';

                // Conviction color
                let convColor = 'text-slate-300';
                if (score.conviction >= 70) convColor = 'text-green-400 font-bold';
                else if (score.conviction >= 50) convColor = 'text-yellow-400';

                // Get price data from momentum signal
                const priceInfo = getPriceInfo(score);
                const priceText = formatPrice(priceInfo.price);
                const changeText = formatChange(priceInfo.change_pct);
                const chgClass = changeClass(priceInfo.change_pct);

                // Signal chips
                const chips = (score.signals || []).map(s => {
                    const chipColor = s.direction === 'bullish' ? 'bg-green-900 text-green-300' : s.direction === 'bearish' ? 'bg-red-900 text-red-300' : 'bg-slate-700 text-slate-300';
                    return `<span class="signal-chip ${chipColor}">${s.layer}</span>`;
                }).join(' ');

                const detailId = `detail-${score.ticker}`;

                const row = document.createElement('div');
                row.innerHTML = `
                    <div class="ticker-row grid grid-cols-12 gap-2 px-4 py-3 items-center border-b border-slate-700/50 fade-in" onclick="toggleDetail('${detailId}')" style="animation-delay: ${index * 50}ms">
                        <div class="col-span-1 text-slate-500 font-mono text-sm">${index + 1}</div>
                        <div class="col-span-3">
                            <div class="font-bold text-white text-lg">${score.ticker}</div>
                            ${priceText ? `<div class="text-xs mt-0.5"><span class="text-slate-400">${priceText}</span> <span class="${chgClass} font-medium">${changeText}</span></div>` : ''}
                        </div>
                        <div class="col-span-1 ${dirColor} font-semibold text-center">
                            <span class="text-lg">${dirArrow}</span>
                        </div>
                        <div class="col-span-3">
                            <div class="flex items-center gap-3">
                                <div class="flex-1 ${barBg} rounded-full overflow-hidden">
                                    <div class="conviction-bar ${barColor}" style="width: ${score.conviction}%"></div>
                                </div>
                                <span class="${convColor} text-sm font-mono w-10 text-right">${score.conviction}%</span>
                            </div>
                        </div>
                        <div class="col-span-2 text-slate-300">
                            <span class="font-bold text-white">${score.active_layers}</span>
                            <span class="text-slate-500"> / ${score.total_layers}</span>
                        </div>
                        <div class="col-span-2 flex flex-wrap gap-1">${chips}</div>
                    </div>
                    <div id="${detailId}" class="detail-panel px-4 bg-slate-850 border-b border-slate-700/50">
                        ${renderDetail(score)}
                    </div>
                `;
                body.appendChild(row);
            });
        }

        // ── Render Signal Detail Panel ──
        function renderDetail(score) {
            if (!score.signals || score.signals.length === 0) {
                return '<p class="text-slate-500 text-sm">No signal details available</p>';
            }

            // Price summary at top of detail
            const priceInfo = getPriceInfo(score);
            let priceSummary = '';
            if (priceInfo.price) {
                const chgClass = changeClass(priceInfo.change_pct);
                priceSummary = `
                    <div class="bg-slate-900 rounded-lg p-4 mb-3 border border-slate-700 grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div>
                            <div class="text-xs text-slate-500 uppercase">Price</div>
                            <div class="text-white font-bold text-lg">${formatPrice(priceInfo.price)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 uppercase">Daily Change</div>
                            <div class="${chgClass} font-bold text-lg">${formatChange(priceInfo.change_pct)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 uppercase">50-Day SMA</div>
                            <div class="text-slate-300 font-mono">${priceInfo.sma_50 ? formatPrice(priceInfo.sma_50) : '—'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 uppercase">200-Day SMA</div>
                            <div class="text-slate-300 font-mono">${priceInfo.sma_200 ? formatPrice(priceInfo.sma_200) : '—'}</div>
                        </div>
                    </div>
                `;
            }

            const signalCards = score.signals.map(signal => {
                const dirColor = signal.direction === 'bullish' ? 'text-green-400' : signal.direction === 'bearish' ? 'text-red-400' : 'text-slate-400';
                const barColor = signal.direction === 'bullish' ? 'bg-green-500' : signal.direction === 'bearish' ? 'bg-red-500' : 'bg-slate-500';
                const dirIcon = signal.direction === 'bullish' ? '&#9650;' : signal.direction === 'bearish' ? '&#9660;' : '&#9644;';

                // Extract key metadata
                let metaItems = [];
                if (signal.metadata) {
                    if (signal.metadata.ma_alignment) metaItems.push({ label: 'MA Alignment', value: signal.metadata.ma_alignment.replace(/_/g, ' ') });
                    if (signal.metadata.relative_volume != null) metaItems.push({ label: 'Rel Volume', value: `${signal.metadata.relative_volume}x` });
                    if (signal.metadata.price_vs_52w != null) metaItems.push({ label: '52w Range', value: `${(signal.metadata.price_vs_52w * 100).toFixed(0)}%` });
                    if (signal.metadata.vix_level != null) metaItems.push({ label: 'VIX', value: Number(signal.metadata.vix_level).toFixed(1) });
                    if (signal.metadata.regime) metaItems.push({ label: 'Regime', value: signal.metadata.regime });
                }

                return `
                    <div class="bg-slate-800 rounded-lg p-4 mb-2 border border-slate-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-bold text-white uppercase tracking-wide">${signal.layer.replace(/_/g, ' ')}</span>
                                <span class="${dirColor} text-sm font-semibold">${dirIcon} ${signal.direction}</span>
                            </div>
                            <div class="flex items-center gap-4 text-xs text-slate-400">
                                <span>Strength: <span class="text-white font-mono">${(signal.strength * 100).toFixed(0)}%</span></span>
                                <span>Confidence: <span class="text-white font-mono">${(signal.confidence * 100).toFixed(0)}%</span></span>
                            </div>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 mb-3">
                            <div class="${barColor} h-1.5 rounded-full transition-all" style="width: ${signal.strength * 100}%"></div>
                        </div>
                        <p class="text-sm text-slate-300">${signal.explanation}</p>
                        ${metaItems.length > 0 ? `
                            <div class="flex flex-wrap gap-3 mt-3">
                                ${metaItems.map(item => `
                                    <div class="bg-slate-700/50 px-3 py-1.5 rounded text-xs">
                                        <span class="text-slate-500">${item.label}:</span>
                                        <span class="text-slate-200 font-medium ml-1">${item.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return priceSummary + signalCards;
        }

        // ── Toggle Detail Panel ──
        function toggleDetail(id) {
            const panel = document.getElementById(id);
            if (panel) {
                panel.classList.toggle('open');
            }
        }

        // ── Refresh Data ──
        async function refreshData() {
            await Promise.all([fetchRegime(), fetchConfluence()]);
        }

        // ── Initialize ──
        refreshData();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);

        // Tick cache age counter every second so it feels alive
        setInterval(() => {
            if (lastCacheAge != null) {
                lastCacheAge += 1;
                updateCacheDisplay(lastCacheAge);
            }
        }, 1000);
    </script>
</body>
</html>
